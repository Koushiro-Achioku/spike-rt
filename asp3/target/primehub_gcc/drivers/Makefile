#  SPDX-License-Identifier: MIT
#
#  Makefile for driver API.
#
#  Copyright (C) 2022 by Embedded and Real-Time Systems Laboratory,
#                        Graduate School of Information Science, Nagoya Univ., JAPAN
#

SYSSVC_COBJS += newlib_stub.o

PYBRICKS_SRCDIR = $(SRCDIR)/../external/libpybricks

ifdef KERNEL_LIB
	PYBRICKS_OBJDIR ?= $(abspath $(KERNEL_LIB)/../obj-primehub_pybricks)
else
	PYBRICKS_OBJDIR ?= $(abspath ../obj-primehub_pybricks)
endif

INCLUDES += -I$(TARGETDIR)/drivers \
						-I$(TARGETDIR)/drivers/cbricks \
						-I$(PYBRICKS_SRCDIR)/lib/pbio/include \
						-I$(PYBRICKS_SRCDIR)/bricks/primehub_asp3 \
						-I$(PYBRICKS_SRCDIR)/lib/pbio/platform/prime_hub_asp3 \
						-I$(PYBRICKS_SRCDIR)/lib/libfixmath/libfixmath \
						-I$(PYBRICKS_SRCDIR)/lib/lego

LDFLAGS += -L$(PYBRICKS_SRCDIR)/bricks/primehub_asp3
LIBS += $(PYBRICKS_OBJDIR)/libpybricks.a

KERNEL_DIRS += $(TARGETDIR)/drivers \
							 $(TARGETDIR)/drivers/cbricks \
							 $(TARGETDIR)/drivers/cbricks/hub \
							 $(TARGETDIR)/drivers/cbricks/pup

KERNEL_COBJS += light.o
KERNEL_COBJS += pup_device.o ultrasonicsensor.o colorsensor.o forcesensor.o

# pybricks.c has to be compiled after TOPPERS configurator (asp3/cfg/cfg.rb) has executed
# because it depends on kernel_cfg.h generated by the configurator.
# So include pybricks.o in SYSSVC_COBJS not KERNEL_COBJS,
# so that pybricks.c is compiled while application building.
SYSSVC_COBJS += pybricks.o

.PHONY: libpybricks.a
libpybricks.a: $(PYBRICKS_OBJDIR)/libpybricks.a

# recipe for building pybricks
.PHONY: $(PYBRICKS_OBJDIR)/libpybricks.a
$(PYBRICKS_OBJDIR)/libpybricks.a:
	$(MAKE) -C $(PYBRICKS_SRCDIR)/bricks/primehub_asp3 BUILD=$(PYBRICKS_OBJDIR)
