#  SPDX-License-Identifier: MIT
# 
#  Makefile for driver API.
#
#  Copyright (C) 2022 by Embedded and Real-Time Systems Laboratory,
#              					 Graduate School of Information Science, Nagoya Univ., JAPAN
#

LIBPYBRICKS_DIR = $(SRCDIR)/../external/libpybricks
INCLUDES += -I$(TARGETDIR)/drivers \
						-I$(TARGETDIR)/drivers/cbricks \
	          -I$(LIBPYBRICKS_DIR)/lib/pbio/include \
	          -I$(LIBPYBRICKS_DIR)/bricks/primehub_asp3 \
	          -I$(LIBPYBRICKS_DIR)/lib/pbio/platform/prime_hub_asp3 \
	          -I$(LIBPYBRICKS_DIR)/lib/libfixmath/libfixmath \
	          -I$(LIBPYBRICKS_DIR)/lib/lego

LDFLAGS += -L$(LIBPYBRICKS_DIR)/bricks/primehub_asp3 
LIBS = $(LIBPYBRICKS_DIR)/bricks/primehub_asp3/libpybricks.a

KERNEL_DIRS += $(TARGETDIR)/drivers \
							 $(TARGETDIR)/drivers/cbricks \
							 $(TARGETDIR)/drivers/cbricks/pup

KERNEL_COBJS += pup_device.o ultrasonicsensor.o

# pybricks.c has to be compiled after TOPPERS configurator (asp3/cfg/cfg.rb) has executed
# because it depends on kernel_cfg.h generated by the configurator.
# So include pybricks.o in SYSSVC_COBJS not KERNEL_COBJS,
# so that pybricks.c is compiled while application building.
SYSSVC_COBJS += pybricks.o

.PHONY: libpybricks.a
libpybricks.a: $(LIBPYBRICKS_DIR)/bricks/primehub_asp3/libpybricks.a

# recipe for building pybricks
.PHONY: $(LIBPYBRICKS_DIR)/bricks/primehub_asp3/libpybricks.a
$(LIBPYBRICKS_DIR)/bricks/primehub_asp3/libpybricks.a:
	make -C $(LIBPYBRICKS_DIR)/bricks/primehub_asp3
